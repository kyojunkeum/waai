<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
<title>WAAI 대시보드</title>
<link rel="stylesheet" href="/static/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="top">
    <div>
      <h1>WAAI 대시보드</h1>
      <div style="font-size: 0.9rem; color: #666;">
        사용자: {{ user }}
      </div>
    </div>
  </header>

  <div class="card">
    <h2>감정 흐름 (mood_score)</h2>
    <canvas id="moodChart" width="900" height="320"></canvas>
  </div>

  <div class="card">
    <h2>/data 파일 목록</h2>
    <div id="data-roots">
      {% for name, root in data_roots.items() %}
        <div style="margin-bottom: 18px;">
          <h3>{{ name }} <span style="font-weight: normal; color: #888;">({{ root }})</span></h3>
          {% set files = data_files.get(name, []) %}
          {% if files %}
            <ul>
              {% for f in files %}
                <li>{{ f.rel_path }}{% if f.size_kb is not none %} <span style="color:#888;">- {{ f.size_kb }}KB</span>{% endif %} <span style="color:#aaa;">{{ f.mtime }}</span></li>
              {% endfor %}
            </ul>
          {% else %}
            <p>파일 없음</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

  <h2>정제 품질 추이 (최근 200회)</h2>

{% if not stats_history or stats_history|length == 0 %}
  <p>(stats 기록이 없습니다. data-format-bot의 /stats 호출이 누적되면 표시됩니다.)</p>
{% else %}
  <table border="1" cellpadding="6" cellspacing="0">
    <thead>
      <tr>
        <th>time</th>
        <th>total_md</th>
        <th>no_front_matter_pct</th>
        <th>missing_required_pct</th>
        <th>tags_violate_pct</th>
        <th>summary_short_pct</th>
      </tr>
    </thead>
    <tbody>
    {% for r in stats_history|reverse %}
      <tr>
        <td>{{ r.get("time","") }}</td>
        <td>{{ r.get("total_md","") }}</td>
        <td>{{ r.get("no_front_matter_pct","") }}</td>
        <td>{{ r.get("missing_required_pct","") }}</td>
        <td>{{ r.get("tags_violate_pct","") }}</td>
        <td>{{ r.get("summary_short_pct","") }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{% endif %}

  <script>
    const moodStats = {{ mood_stats | tojson | safe }};

    const labels = moodStats.map(s => s.date);
    const avgData = moodStats.map(s => s.avg_mood_score);
    const minData = moodStats.map(s => s.min_mood_score);
    const maxData = moodStats.map(s => s.max_mood_score);

    const ctx = document.getElementById('moodChart').getContext('2d');
    const moodChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: '평균 mood_score',
            data: avgData,
            borderWidth: 2,
            tension: 0.15
          },
          {
            label: '최소 mood_score',
            data: minData,
            borderWidth: 1,
            borderDash: [5, 5],
            tension: 0.15
          },
          {
            label: '최대 mood_score',
            data: maxData,
            borderWidth: 1,
            borderDash: [5, 5],
            tension: 0.15
          },
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
  </script>

</body>
</html>
